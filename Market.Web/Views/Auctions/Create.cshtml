@model Market.Web.Models.Auction

@{
    ViewData["Title"] = "Dodaj Aukcję";
}

<div class="container ">
    <div class="d-flex justify-content-between align-items-center>
        <div>
            <h2 class="mb-0">Wystaw Przedmiot</h2>
            <small class="text-secondary">Uzupełnij dane ręcznie lub użyj AI</small>
        </div>
        <a asp-action="Index" class="btn btn-secondary mt-4 mb-3">
            <i class="bi bi-x-lg"></i> Anuluj / Wróć
        </a>
    </div>

    <div id="aiErrorAlert" class="alert alert-danger d-none" role="alert">
        <strong>Ups! Coś poszło nie tak z AI:</strong> <span id="aiErrorMessage"></span>
    </div>

    <form asp-action="Create" enctype="multipart/form-data">
        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

         <div class="card bg-dark border-secondary mb-4">
            <div class="card-body">
                
                <div id="galleryContainer" class="d-none">

                    <div class="ratio ratio-4x3 bg-black border border-secondary rounded shadow-sm mb-3">
                        <img id="mainPreviewImage" src="" class="object-fit-contain w-100 h-100" alt="Główny podgląd">
                    </div>

                    <div class="d-flex flex-column align-items-center">
                        <small class="text-secondary mb-2">Kliknij miniaturę, aby zmienić podgląd</small>
                        <div id="thumbnailsContainer" class="d-flex flex-wrap gap-2 justify-content-center overflow-auto" style="max-height: 160px;">

                        </div>
                    </div>
                </div>

                <div class="row g-3">

                    <div class="col-12">
                        <label class="form-label fw-bold">Zdjęcia przedmiotu</label>
                        <input type="file" name="photos" id="photosInput" class="form-control bg-dark text-light border-secondary" multiple accept="image/*" />
                    </div>

                    <div class="col-12">
                        <button type="button" id="aiButton" class="btn btn-warning w-100 fw-bold shadow-sm py-3">
                            ✨ Generuj opis z AI
                            <span id="spinner" class="spinner-border spinner-border-sm d-none ms-2" role="status" aria-hidden="true"></span>
                        </button>
                    </div>
                </div>

            </div>
        </div>


        <div class="row g-3">
            <!-- Tytuł (Pełna szerokość) -->
            <div class="col-12">
                <div class="form-floating">
                    <input asp-for="Title" class="form-control" placeholder="Tytuł aukcji" />
                    <label asp-for="Title">Tytuł Aukcji</label>
                </div>
                <span asp-validation-for="Title" class="text-danger"></span>
            </div>

            <!-- Kategoria i Data (Po 50%) -->
            <div class="col-md-6">
                <div class="form-floating">
                    <select asp-for="Category" class="form-select">
                        <option value="">wybierz...</option>
                        <option value="Elektronika">Elektronika</option>
                        <option value="Moda">Moda</option>
                        <option value="Dom i Ogród">Dom i Ogród</option>
                        <option value="Sport i Hobby">Sport i Hobby</option>
                        <option value="Motoryzacja">Motoryzacja</option>
                        <option value="Kultura i Rozrywka">Kultura i Rozrywka</option>
                        <option value="Inne">Inne</option>
                    </select>
                    <label asp-for="Category">Kategoria</label>
                </div>
                <span asp-validation-for="Category" class="text-danger"></span>
            </div>

            <div class="col-md-6">
                <div class="form-floating">
                    <input asp-for="EndDate" class="form-control" type="date" min="@DateTime.Today.ToString("dd-MM-yyyy")" />
                    <label asp-for="EndDate">Data zakończenia</label>
                </div>
                <span asp-validation-for="EndDate" class="text-danger"></span>
            </div>

            <!-- Cena i Ilość (Mniejsze kolumny) -->
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text">PLN</span>
                    <div class="form-floating flex-grow-1">
                        <input asp-for="Price" class="form-control" type="number" step="0.01" placeholder="Cena" />
                        <label asp-for="Price">Cena</label>
                    </div>
                </div>
                <span asp-validation-for="Price" class="text-danger"></span>
            </div>

            <div class="col-md-4">
                <div class="form-floating">
                    <input asp-for="Quantity" class="form-control" type="number" min="1" placeholder="Ilość" />
                    <label asp-for="Quantity">Ilość sztuk</label>
                </div>
                <span asp-validation-for="Quantity" class="text-danger"></span>
            </div>
            <div class="col-md-4 d-none d-md-block"></div>

            <!-- Opis (Pełna szerokość, wysoki) -->
            <div class="col-12">
                <label asp-for="Description" class="form-label fw-bold mt-2">Szczegółowy Opis</label>
                <textarea asp-for="Description" class="form-control" rows="12" placeholder="Opis przedmiotu..."></textarea>
                <span asp-validation-for="Description" class="text-danger"></span>
            </div>

            <!-- Przycisk Submit -->
            <div class="col-12 mt-4">
                <input type="submit" value="Wystaw na Sprzedaż" class="btn btn-primary btn-lg w-100 py-3 fw-bold" />
            </div>
        </div>
    </form>
</div>


@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // ELEMENTY DOM
            const btnGenerate = document.getElementById('aiButton');
            const fileInput = document.getElementById('photosInput');
            const galleryContainer = document.getElementById('galleryContainer');
            const mainImage = document.getElementById('mainPreviewImage');
            const thumbnailsContainer = document.getElementById('thumbnailsContainer');
            const spinner = document.getElementById("spinner");
            const alertBox = document.getElementById('aiErrorAlert');
            const alertMsg = document.getElementById('aiErrorMessage');

            // --- 1. OBSŁUGA GENEROWANIA AI ---
            if(btnGenerate) {
                btnGenerate.addEventListener("click", async function (e) {
                    e.preventDefault();
                    alertBox.classList.add("d-none");

                    if (!fileInput.files.length) {
                        alertMsg.innerText = "Proszę najpierw wybrać zdjęcia produktu!";
                        alertBox.classList.remove("d-none");
                        return;
                    }

                    spinner.classList.remove("d-none");
                    btnGenerate.disabled = true;

                    const formData = new FormData();
                    for (let i = 0; i < fileInput.files.length; i++) {
                        formData.append("photos", fileInput.files[i]);
                    }

                    try {
                        const response = await fetch('/Auctions/GenerateDescription', {
                            method: 'POST',
                            body: formData
                        });

                        if (!response.ok) {
                            const err = await response.json();
                            throw new Error(err.error || "Wystąpił błąd serwera");
                        }

                        const data = await response.json();

                        if (data.title && data.title.startsWith("ERROR:")) {
                             throw new Error(data.title.replace("ERROR:", "").trim());
                        }

                        if (data.title) document.getElementById("Title").value = data.title;
                        if (data.description) document.getElementById("Description").value = data.description;
                        if (data.suggestedPrice) document.getElementById("Price").value = data.suggestedPrice;

                        if (data.category) {
                            const categorySelect = document.getElementById("Category");
                            let options = Array.from(categorySelect.options);
                            let optionToSelect = options.find(item => item.value === data.category);
                            if (optionToSelect) categorySelect.value = data.category;
                        }

                    } catch (error) {
                        alertMsg.innerText = error.message;
                        alertBox.classList.remove("d-none");
                    } finally {
                        spinner.classList.add("d-none");
                        btnGenerate.disabled = false;
                    }
                });
            }

            // --- 2. OBSŁUGA GALERII (STACK STYLE) ---
            if (fileInput && galleryContainer && mainImage && thumbnailsContainer) {
                fileInput.addEventListener('change', function () {
                    thumbnailsContainer.innerHTML = '';
                    mainImage.src = '';
                    
                    const files = Array.from(this.files);
                    
                    if (files.length === 0) {
                        galleryContainer.classList.add('d-none');
                        return;
                    }

                    galleryContainer.classList.remove('d-none');

                    files.forEach((file, index) => {
                        if (!file.type.startsWith('image/')) return;

                        const reader = new FileReader();
                        reader.onload = function (e) {
                            const imgSrc = e.target.result;

                            // Pierwsze zdjęcie idzie na górę
                            if (index === 0) {
                                mainImage.src = imgSrc;
                            }

                            // Miniatura
                            const thumbWrapper = document.createElement('div');
                            thumbWrapper.style.width = '80px';
                            thumbWrapper.style.height = '80px';
                            thumbWrapper.style.cursor = 'pointer';
                            // Dodajemy border-light dla miniatur nieaktywnych, żeby było je widać na ciemnym tle
                            thumbWrapper.className = `border rounded overflow-hidden position-relative ${index === 0 ? 'border-warning border-3' : 'border-secondary'}`;
                            
                            thumbWrapper.innerHTML = `
                                <img src="${imgSrc}" class="object-fit-cover w-100 h-100" alt="Thumb">
                            `;

                            thumbWrapper.addEventListener('click', function() {
                                mainImage.src = imgSrc;
                                
                                Array.from(thumbnailsContainer.children).forEach(child => {
                                    child.classList.remove('border-warning', 'border-3');
                                    child.classList.add('border-secondary');
                                });
                                thumbWrapper.classList.remove('border-secondary');
                                thumbWrapper.classList.add('border-warning', 'border-3');
                            });

                            thumbnailsContainer.appendChild(thumbWrapper);
                        };
                        reader.readAsDataURL(file);
                    });
                });
            }
        });
    </script>
}